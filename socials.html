<!DOCTYPE html>
<html>
	<head>
		<title>Socials</title>
		<link rel="stylesheet" href="style.css" />
		<link rel="icon" href="img/icon.jpg" type="image/x-icon" />
	</head>
	<body style="overflow: hidden; display: flex; flex-direction: column;">
		<h1>Зв'язок зі мною</h1>
		<table align="center">
			<tr>
				<th>
					<button class="footer-button" style="margin: 2px" onclick="window.open('https://t.me/bloodbern', '_blank')">My Telegram</button>
				</th>
			</tr>
			<tr>
				<th>
					<button class="footer-button" style="margin: 2px" onclick="window.open('https://instagram.com/bloodbern', '_blank')">My Instagram</button>
				</th>
			</tr>
			<tr>
				<th>
					<button class="footer-button" style="margin: 2px" onclick="window.open('mailto:bloodbern09@gmail.com', '_blank')">Напишіть мені!</button>
				</th>
			</tr>
			<tr>
				<th>
					<button id="play-button" class="footer-button" style="margin: 2px" onclick="startGame()"></button>
				</th>
			</tr>
		</table>

		<div id="game">
			<span id="game-time"></span>
			<div id="health-display"></div>
			<div id="food-items-container"></div>
			<div id="chopsticks-container">
				<div class="chopstick"></div>
				<div class="chopstick">
					<div id="chopsticks-hitbox"></div>
				</div>
			</div>
			<div id="right-wall"></div>
			<div id="conveyor"></div>
			<div id="low-hp-overlay"></div>
		</div>

		<script>
			const gravity = 2;
			const horizontalDamping = 1.03;
			const terminalVelocity = 50;

			const initialHealth = 3;
			const initialSpawnInterval = 1500;
			const minSpawnInterval = 500;
			const initialSpawnVariation = 1000;
			const spawnIntervalSpeedUp = 10;

			const conveyorSpeed = 3;

			const playButton = document.getElementById("play-button");
			const game = document.getElementById("game");
			const gameTime = document.getElementById("game-time");
			const healthDisplay = document.getElementById("health-display");
			const foodItemsContainer = document.getElementById("food-items-container");
			const chopsticksContainer = document.getElementById("chopsticks-container");
			const chopsticksHitbox = document.getElementById("chopsticks-hitbox");
			const rightWall = document.getElementById("right-wall");
			const conveyor = document.getElementById("conveyor");
			const lowHpOverlay = document.getElementById("low-hp-overlay");

			const chopsticks = chopsticksContainer.children;
			let foodItems = [];
			let caughtFoodItem = null;

			let mainLoop = null;
			let health = 0;
			let gameStartTimestamp = 0;

			function startGame() {
				if (mainLoop) {
					clearInterval(mainLoop);

					mainLoop = null;

					for (const foodItem of foodItems) {
						foodItem.despawn();
					}

					caughtFoodItem = null;

					healthDisplay.replaceChildren([]);

					lowHpOverlay.classList.remove("visible");
				}

				else {
					gameStartTimestamp = Date.now();

					let spawnInterval = initialSpawnInterval;
					let spawnVariation = initialSpawnVariation;

					let nextSpawnTimestamp = gameStartTimestamp + 1000;

					health = initialHealth;

					mainLoop = setInterval(() => {
						const timestamp = Date.now();

						gameTime.innerText = formatTime(timestamp - gameStartTimestamp);

						for (const foodItem of foodItems) {
							if (foodItem === caughtFoodItem) {
								continue;
							}

							foodItem.move();

							if (foodItem.isOnConveyor || !elementsOverlapping(foodItem.image, conveyor)) {
								continue;
							}

							foodItem.isOnConveyor = true;
						}

						if (timestamp > nextSpawnTimestamp) {
							const foodItem = new FoodItem();

							foodItem.spawn();

							nextSpawnTimestamp = timestamp + spawnInterval + (Math.random() * spawnVariation);

							spawnInterval = Math.max(spawnInterval - spawnIntervalSpeedUp, minSpawnInterval);
							spawnVariation = Math.max(spawnVariation - spawnIntervalSpeedUp, 0);
						}
					}, 16.666666);

					for (let i = 0; i < initialHealth; i++) {
						const heart = document.createElement("img");

						heart.src = "https://cdn-icons-png.flaticon.com/512/1762/1762755.png";

						healthDisplay.appendChild(heart);
					}
				}

				game.classList.toggle("running");

				updatePLayButtonText();
			}

			function updatePLayButtonText() {
				playButton.innerText = mainLoop === null ? "Shall we play a game? :)" : "I don't wanna play anymore :(";
			};

			function elementsOverlapping(element1, element2) {
				const rect1 = element1.getBoundingClientRect();
				const rect2 = element2.getBoundingClientRect();

				return rect1.right > rect2.left &&
					rect1.left < rect2.right &&
					rect1.bottom > rect2.top &&
					rect1.top < rect2.bottom;
			}

			function formatTime(miliseconds) {
				return [
					Math.floor(miliseconds / 60 / 60 / 1000),
					Math.floor(miliseconds / 60 / 1000) % 60,
					Math.floor(miliseconds / 1000) % 60,
				]
					.map((value) => String(value).padStart(2, "0"))
					.filter((value, index) => value !== "00" || index > 0)
					.join(":")
					.concat(".")
					.concat(String(miliseconds % 60).padStart(3, "0"))
			}

			class FoodItem {
				constructor() {
					const images = [
						"https://cdn-icons-png.flaticon.com/512/3259/3259041.png",
						"https://cdn-icons-png.flaticon.com/512/2515/2515345.png",
						"https://cdn-icons-png.flaticon.com/512/2718/2718224.png",
						"https://cdn-icons-png.flaticon.com/512/3361/3361870.png",
						"https://cdn-icons-png.flaticon.com/512/2713/2713962.png"
					].toSorted(() => 0.5 - Math.random());

					const width = 80;

					const image = document.createElement("img");
					image.classList.add("game-food-item");
					image.src = images[0];
					image.style.width = `${width}px`;
					image.style.top = `${Math.random() * (foodItemsContainer.clientHeight / 2)}px`;

					this.image = image;

					this.size = width;

					this.velocity = {
						x: 5 + Math.random() * 10,
						y: -10 - (Math.random() * 20)
					};
					this.previousGrabPosition = {
						x: 0,
						y: 0
					};

					this.isOnConveyor = false;
				}

				spawn() {
					foodItemsContainer.appendChild(this.image);
					foodItems.push(this);

					new Audio('sounds/woosh_s21KzKN.mp3').play();
				}

				move() {
					if (this.isOnConveyor) {
						this.image.style.top = null;

						this.image.style.left = `${this.image.offsetLeft + conveyorSpeed}px`;
						this.image.style.bottom = `${conveyor.offsetHeight}px`;
					}
					else {
						if (elementsOverlapping(rightWall, this.image)) {
							this.velocity.x = -20;
							this.velocity.y = -50;
						}

						this.image.style.left = `${this.image.offsetLeft + this.velocity.x}px`;
						this.image.style.top = `${this.image.offsetTop + this.velocity.y}px`;

						this.velocity.x /= horizontalDamping;
						this.velocity.y = Math.min(this.velocity.y + gravity, terminalVelocity);
					}

					this.tryDespawn();
				}

				setPosition(x, y) {
					this.image.style.left = `${x - this.size / 2}px`;
					this.image.style.top = `${y - this.size / 2}px`;

					const newGrabPosition = {
						x: this.image.offsetLeft,
						y: this.image.offsetTop
					};

					this.velocity = {
						x: newGrabPosition.x - this.previousGrabPosition.x,
						y: newGrabPosition.y - this.previousGrabPosition.y
					};

					this.previousGrabPosition = newGrabPosition;

					this.tryDespawn();
				}

				tryDespawn() {
					if (this.image.offsetTop < game.clientHeight &&
						this.image.offsetLeft < game.clientWidth) {
						return;
					}

					this.despawn();

					if (this.isOnConveyor) {
						new Audio('sounds/anime-wow-sound-effect.mp3').play();

						return;
					}

					healthDisplay.firstElementChild.remove();

					new Audio('sounds/classic_hurt.mp3').play();

					if (--health > 0) {
						if (health === 1) {
							lowHpOverlay.classList.add("visible");
						}

						return;
					}

					startGame();

					alert(`You ded xD\nYou lasted: ${formatTime(Date.now() - gameStartTimestamp)}`);
				}

				despawn() {
					foodItemsContainer.removeChild(this.image);
					foodItems = foodItems.filter(foodItem => foodItem !== this);
				}

				catch(x, y) {
					this.setPosition(x, y);

					this.velocity = {
						x: 0,
						y: 0
					};

					caughtFoodItem = this;
				}

				release() {
					caughtFoodItem = null;
				}
			}

			game.addEventListener("mousemove", event => {
				const cursorPosition = {
					x: event.clientX - game.offsetLeft,
					y: event.clientY - game.offsetTop
				};

				for (const chopstick of chopsticks) {
					chopstick.style.left = `${Math.max(cursorPosition.x, 0)}px`;
					chopstick.style.top = `${Math.max(cursorPosition.y, 60)}px`;
				}

				caughtFoodItem?.setPosition(cursorPosition.x, cursorPosition.y);
			});

			game.addEventListener("mouseenter", event => {
				game.style.cursor = "none";
			});

			game.addEventListener("mouseleave", event => {
				game.style.cursor = null;
			});

			game.addEventListener("mousedown", event => {
				const cursorPosition = {
					x: event.clientX - game.offsetLeft,
					y: event.clientY - game.offsetTop
				};

				chopsticks.item(0).classList.add("grab");

				for (const foodItem of foodItems) {
					if (!elementsOverlapping(chopsticksHitbox, foodItem.image)) {
						continue;
					}

					foodItem.catch(cursorPosition.x, cursorPosition.y);
				}
			});

			game.addEventListener("mouseup", event => {
				chopsticks.item(0).classList.remove("grab");

				caughtFoodItem?.release(event.movementX, event.movementY);
			});

			updatePLayButtonText();
		</script>
	</body>
</html>